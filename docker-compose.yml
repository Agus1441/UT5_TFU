services:
  monolith:
    build: .
    ports: ["3000:3000"]
    environment:
      DATABASE_URL: postgres://postgres:dev@database:5432/postgres
      REDIS_URL: redis://redis:6379
      QUEUE_URL: amqp://guest:guest@queue:5672/
      FAILURE_RATE: "0.3"
      CB_ERROR_THRESHOLD: "5"
      CB_TIMEOUT_MS: "10000"
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:3000/health"]
      interval: 10s
      retries: 5
    depends_on: [database, redis, queue]

  database:
    image: postgres:16
    environment:
      POSTGRES_PASSWORD: dev
    ports: ["5432:5432"]
    volumes:
      - postgres_data:/var/lib/postgresql/data

  redis:
    image: redis:7
    ports: ["6379:6379"]

  queue:
    image: rabbitmq:3-management
    ports: ["15672:15672"]
    environment:
      RABBITMQ_DEFAULT_USER: guest
      RABBITMQ_DEFAULT_PASS: guest

volumes:
  postgres_data:

